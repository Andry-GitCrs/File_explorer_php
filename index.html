<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Cool File Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
      body{background:#1e1e2f;color:#fff;}
      .menu{background:#1e1e2fe3;color:#fff;backdrop-filter: blur(5px);}
      .sidebar{background:#27293d;min-height:100vh}
      .nav-link{color:#fff}
      .nav-link:hover{background: #3a3b5c}
      .file-item{cursor:pointer; border: 2px solid transparent!important;}
      .file-item:hover{border: 2px solid #3a3b5c!important; transition: border-color 0.3s;}
      .breadcrumb-item a{text-decoration:none;color:#ff8a00}
      #editor{height:60vh;background:#1e1e2f;color:#fff;border:1px solid #444}
      .modal-content{background:#27293d;color:#fff}
      .modal-backdrop.fade.show{z-index: -9999!important;}
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- MAIN PANEL -->
      <main class="col-md-12 ms-sm-auto col-lg-12 px-md-4">
        <div class="menu position-sticky top-0 d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom border-secondary border-2">
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary" onclick="ls(dirname(currentPath))">
              <i class="bi bi-arrow-left"></i>
            </button>
            <nav class="d-flex align-items-center" aria-label="breadcrumb">            
              <button class="btn btn-sm text-primary me-2" onclick="createItem('file')"><i class="fs-5 bi bi-file-earmark-plus"></i></button>
              <button class="btn btn-sm text-success me-2" onclick="createItem('dir')"><i class="fs-5 bi bi-folder-plus"></i></button>
              <button class="btn btn-sm text-secondary me-2" onclick="ls('data')"><i class="fs-5 bi bi-house"></i></button>
              <button class="btn btn-sm text-secondary me-2" onclick="ls('C:\\Users\\Andry')"><i class="fs-5 bi bi-person"></i></button>
              <button class="btn btn-sm text-success me-2" onclick="ls('C:\\Users\\Andry\\OneDrive\\Desktop')"><i class="fs-5 bi bi-display"></i></button>
              <ol id="breadcrumb" class="breadcrumb mb-0"></ol>
            </nav>
          </div>
          <h5 class="text-light">
            <i class="bi bi-folder2-open"></i> My file explorer
          </h5>
        </div>

        <div id="fileList" class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-2"></div>

        <!-- Editor Modal -->
        <div class="modal fade" id="editorModal" tabindex="-1" style="z-index: 9999;">
          <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
              <div class="modal-header">
                <h5 id="editorTitle" class="modal-title"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <textarea id="editor" class="form-control"></textarea>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                <button class="btn btn-primary" onclick="saveFile()">Sauvegarder</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Context Menu -->
        <ul id="ctx" class="dropdown-menu" style="position:absolute;display:none;">
          <li><a class="dropdown-item" href="#" onclick="renamePrompt()"><i class="bi bi-pencil"></i> Renommer</a></li>
          <li><a class="dropdown-item" href="#" onclick="copyPrompt()"><i class="bi bi-files"></i> Copier</a></li>
          <li><a class="dropdown-item" href="#" onclick="movePrompt()"><i class="bi bi-arrows-move"></i> Déplacer</a></li>
          <li><a class="dropdown-item text-danger" href="#" onclick="deletePrompt()"><i class="bi bi-trash"></i> Supprimer</a></li>
        </ul>
      </main>
    </div>
  </div>
  <!-- nofitication displayer -->
  <div id="notification" class="d-none position-fixed top-0 start-50 translate-middle-x mt-3 px-4 py-3 shadow rounded text-white d-flex align-items-center gap-2" style="z-index: 9999; min-width: 250px;">
      <i id="notification-icon" class=""></i>
      <span id="notification-message"></span>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ---------- STATE ---------- */
    let currentPath = 'data';
    let selectedItem = null;

    /* ---------- HELPERS ---------- */
    const api = (action, params={}, method='GET', body=null)=> {
      const url = new URL('api.php', location.href);
      url.searchParams.set('action', action);
      Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
      return fetch(url, {method, body}).then(r=>r.json());
    };

    const basename = p=>p.split('/').pop();
    const dirname  = p=>p.split('/').slice(0,-1).join('/') || 'data';

    /* ---------- RENDER ---------- */
    async function ls(path){
      currentPath = path;
      const items = await api('ls', {path});
      renderBreadcrumb(path);
      const list = document.getElementById('fileList');
      list.innerHTML='';


      if(!items.length){
        list.innerHTML='<div class="col-12 mx-auto my-5 text-center" style="color: #aaa"> <i class="bi bi-folder2"></i> Le dossier est vide</div>';
        return;
      }

      items.forEach(item => {
        const col = document.createElement('div');
        col.className='col-md-2 col-6 p-2';
        col.innerHTML=`
          <div class="rounded-3 file-item border-secondary" data-path="${item.path}" data-type="${item.type}">
            <div class="card-body text-center p-2">
              ${
                item.type === 'file' && isImage(item.name)
                  ? `<img onclick="window.open('preview.php?path=${encodeURIComponent(item.path)}', '_blank')" src="preview.php?path=${encodeURIComponent(item.path)}" alt="${item.name}" class="p-0 img-thumbnail" style="max-width: 100px; max-height: 100px;">`
                  : item.type === 'file' && isOpenable(item.name) ?  `<i onclick="window.open('preview.php?path=${encodeURIComponent(item.path)}', '_blank')" class="bi ${getFileIconClass(item.name)} fs-1"></i>` :
                    item.type === 'dir'
                      ? `<i class="bi bi-folder text-warning fs-1"></i>`
                      : `<i class="bi ${getFileIconClass(item.name)} fs-1"></i>`
              }
              <div class="mt-2 text-light text-truncate">${item.name}</div>
              <small class="" style="color: #aaa">${item.type === 'file' ? formatFileSize(item.size) : ''}</small>
              <div class="" style="color: #aaa; font-size: 0.8em">${item.date}</div>
            </div>
          </div>`;
        col.onclick = () => { openItem(item); };
        col.oncontextmenu = (e) => { e.preventDefault(); showCtx(e, item); };
        list.append(col);
      });
    }

    function renderBreadcrumb(p){
      const parts = p.split('/');
      let path = '';
      const html = parts.map((part, i) => {
        path += (i ? '/' : '') + part;
        return `
        <li class="breadcrumb-item border border-secondary border-1 p-1 rounded-3 me-2">
          <a href="#" onclick="ls('${path}')">${part}</a>
        </li>`;
      }).join('');
      document.getElementById('breadcrumb').innerHTML = html;
    }


    // ---------- OPEN ----------
    async function openItem(item) {
      if (item.type === 'dir') return ls(item.path);
      selectedItem = item;

      try {
        const res = await api('read', { path: item.path });

        showNotification(res.status, res.msg);

        document.getElementById('editorTitle').textContent = basename(item.path);
        document.getElementById('editor').value = res.content || '';
        bootstrap.Modal.getOrCreateInstance(document.getElementById('editorModal')).show();
        return;

      } catch (err) {
        console.log(err);
        if (err) showNotification('error', 'Impossible d’ouvrir le fichier.');
      }
    }

    /* ---------- CREATE ---------- */
    async function createItem(type){
      const name = prompt("Nom ?");
      if(!name) return;
      const dest = currentPath + '/' + name;
      const res = await api(type==='file' ? 'createFile':'createDir', {path:dest})
        .then((res)=>{
          showNotification(res.status, res.msg)
          ls(currentPath)
        });
    }

    /* ---------- ACTIONS ---------- */
    async function saveFile(){
      const res = await api('write',{path:selectedItem.path},'POST',document.getElementById('editor').value)
        .then((res)=>{
          showNotification(res.status, res.msg)
          bootstrap.Modal.getInstance(document.getElementById('editorModal')).hide()
        });
    }

    async function deletePrompt(){
      if(!confirm('Vous voulez Supprimer '+basename(selectedItem.path)+' ?')) return;
      const res = await api('delete',{path:selectedItem.path}).then((res)=>{
        showNotification(res.status, res.msg)
        ls(currentPath)
      });
      hideCtx();
    }

    async function renamePrompt(){
      const newName = prompt('Nouveau nom', basename(selectedItem.path));
      if(!newName) return;
      const res = await api('rename',{path:selectedItem.path,target:dirname(selectedItem.path)+'/'+newName})
        .then((res)=>{
          showNotification(res.status, res.msg)
          ls(currentPath)
        });
      hideCtx();
    }

    async function copyPrompt(){
      const dest = prompt('Copier vers (chemin complet)', selectedItem.path + '_copie');
      if(!dest) return;
      const res = await api('copy',{path:selectedItem.path, target:dest}).then((res)=>{
        showNotification(res.status, res.msg)
        ls(currentPath)
      });
      hideCtx();
    }

    async function movePrompt(){
      const dest = prompt('Déplacer vers (chemin complet)', selectedItem.path);
      if(!dest) return;
      const res = await api('move',{path:selectedItem.path,target:dest}).then((res)=>{
        showNotification(res.status, res.msg)
        ls(dirname(selectedItem.path))
      });
      hideCtx();
    }

    /* ---------- CONTEXT MENU ---------- */
    function showCtx(e, item){
      selectedItem=item;
      const ctx=document.getElementById('ctx');
      ctx.style.top=e.pageY+'px';
      ctx.style.left=e.pageX+'px';
      ctx.style.display='block';
    }
    function hideCtx(){ document.getElementById('ctx').style.display='none'; }
    document.onclick=hideCtx;

    /* ---------- INIT ---------- */
    ls(currentPath);

    //Notification displayer
    function showNotification(type, message, duration = 5000) {
        const containerId = 'notification-container';

        // Create the container once
        let container = document.getElementById(containerId);
        if (!container) {
            container = document.createElement('div');
            container.id = containerId;
            container.className = 'position-fixed bottom-0 end-0 p-3 d-flex flex-column align-items-end gap-2 z-9999';
            document.body.appendChild(container);
        }

        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'toast-notification px-4 py-3 shadow rounded text-white d-flex align-items-center justify-content-between gap-3';
        notification.style.minWidth = '280px';
        notification.style.opacity = 0;
        notification.style.transform = 'translateY(20px)';
        notification.style.transition = 'opacity 0.5s ease, transform 0.5s ease';

        // Icon
        const icon = document.createElement('i');
        icon.classList.add('fas');

        // Set icon and background based on type
        switch (type) {
            case 'success':
                notification.classList.add('bg-success');
                icon.classList.add('fa-check-circle');
                break;
            case 'error':
                notification.classList.add('bg-danger');
                icon.classList.add('fa-circle-exclamation');
                break;
            case 'info':
                notification.classList.add('bg-info');
                icon.classList.add('fa-info-circle');
                break;
            case 'warning':
                notification.classList.add('bg-warning', 'text-dark');
                icon.classList.add('fa-exclamation-triangle');
                break;
            default:
                notification.classList.add('bg-secondary');
                icon.classList.add('fa-bell');
        }

        // Message
        const messageBox = document.createElement('span');
        messageBox.textContent = message;

        // Close button
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = `<i className="fas fa-times"></i>`;
        closeBtn.className = 'btn-close btn-close-white ms-auto';
        closeBtn.style.filter = 'brightness(0) invert(1)';
        closeBtn.style.fontSize = '1rem';
        closeBtn.style.opacity = '0.8';
        closeBtn.addEventListener('click', () => {
            notification.style.opacity = 0;
            notification.style.transform = 'translateY(20px)';
            setTimeout(() => notification.remove(), 500);
        });

        // Assemble notification
        const contentWrap = document.createElement('div');
        contentWrap.className = 'd-flex align-items-center gap-2';
        contentWrap.appendChild(icon);
        contentWrap.appendChild(messageBox);

        notification.appendChild(contentWrap);
        notification.appendChild(closeBtn);
        container.appendChild(notification);

        // Show animation
        setTimeout(() => {
            notification.style.opacity = 1;
            notification.style.transform = 'translateY(0)';
        }, 10);

        // Auto-hide
        setTimeout(() => {
            notification.style.opacity = 0;
            notification.style.transform = 'translateY(20px)';
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 500);
        }, duration);
    }

    function isImage(filename) {
      return /\.(jpe?g|png|gif|bmp|webp|svg)$/i.test(filename);
    }

    function isOpenable(filename) {
      return /\.(mp4|mkv|avi|pdf|html)$/i.test(filename);
    }

    function formatFileSize(bytes) {
      const units = ['bytes', 'KB', 'MB', 'GB', 'TB'];
      let i = 0;
      while (bytes >= 1024 && i < units.length - 1) {
        bytes /= 1024;
        i++;
      }
      return `${bytes.toFixed(1)} ${units[i]}`;
    }

    function getFileIconClass(filename) {
      const ext = filename.split('.').pop().toLowerCase();

      if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'].includes(ext)) return '';
      if (['mp4', 'webm', 'avi', 'mkv', 'mov'].includes(ext)) return 'bi-file-earmark-play text-danger';
      if (['mp3', 'wav', 'ogg', 'flac'].includes(ext)) return 'bi-file-earmark-music text-info';
      if (['pdf'].includes(ext)) return 'bi-file-earmark-pdf text-danger';
      if (['doc', 'docx'].includes(ext)) return 'bi-file-earmark-word text-primary';
      if (['xls', 'xlsx', 'csv'].includes(ext)) return 'bi-file-earmark-excel text-success';
      if (['ppt', 'pptx'].includes(ext)) return 'bi-file-earmark-slides text-warning';
      if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) return 'bi-file-earmark-zip text-success';
      if (['txt', 'md', 'log'].includes(ext)) return 'bi-file-earmark-text text-light';

      // NEW: Code file icons
      if (['html', 'htm'].includes(ext)) return 'bi-filetype-html text-warning';
      if (['js', 'mjs'].includes(ext)) return 'bi-filetype-js text-warning';
      if (['css'].includes(ext)) return 'bi-filetype-css text-info';
      if (['php'].includes(ext)) return 'bi-filetype-php text-primary';
      if (['py'].includes(ext)) return 'bi-filetype-py text-success';
      if (['java', 'class'].includes(ext)) return 'bi-filetype-java text-danger';
      if (['c', 'cpp', 'h', 'hpp'].includes(ext)) return 'bi-filetype-cpp text-light';
      if (['json', 'xml', 'yml', 'yaml'].includes(ext)) return 'bi-file-earmark-code text-light';

      return 'bi-file-earmark text-light';
    }
  </script>
</body>
</html>